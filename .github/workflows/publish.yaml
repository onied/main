name: Publish Docker Images

on: [push]

env:
    REGISTRY: ghcr.io
    
    IMAGE_NAME: ${{ github.repository }}
    PROJECT_NAME: onied
    DATABASE_HOST: localhost
    DATABASE_PORT: 5432
    DATABASE_USER: postgres
    DATABASE_PASS: postgres
    DATABASE_NAME: certificates_database
    MAPBOX_API_KEY: ${{ secrets.MAPBOX_API_KEY }}  # Используйте секреты для чувствительных данных
    MAPBOX_API_URL: https://api.mapbox.com/search/geocode/v6/forward
    PURCHASES_API_URL: http://localhost:5036/api/v1/purchases/verify
    RABBITMQ_CONNECTION_STRING: amqp://guest:guest@localhost:5672
  
jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            # - name: Log in to Docker Hub
            #   uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
            #   with:
            #     username: ${{ secrets.DOCKERHUB_USER }}
            #     password: ${{ secrets.DOCKERHUB_TOKEN }}

            # - name: Log in to the Container registry
            #   uses: docker/login-action@v3
            #   with:
            #     registry: ${{ env.REGISTRY }}
            #     username: ${{ github.actor }}
            #     password: ${{ secrets.PAT }}
            
            # - name: Build Docker images
            #   run: docker compose build

            - name: Create a tarball of the docker-compose directory
              run: tar -czf ${{ env.PROJECT_NAME }}.tar.gz ./*

            - name: Copy tarball to remote server
              uses: appleboy/scp-action@master
              with:
                host: ${{ secrets.SSH_HOST }}
                port: ${{ secrets.SSH_PORT }}
                username: ${{ secrets.SSH_USER }}
                key: ${{ secrets.SSH_CD_KEY }}
                source: ${{ env.PROJECT_NAME }}.tar.gz
                target: ~/${{ env.PROJECT_NAME }}.tar.gz

            - name: SSH to remote server and deploy with Docker Compose
              uses: appleboy/ssh-action@master
              with:
                host: ${{ secrets.SSH_HOST }}
                port: ${{ secrets.SSH_PORT }}
                username: ${{ secrets.SSH_USER }}
                key: ${{ secrets.SSH_CD_KEY }}
                script: |
                  mkdir ~/${{ env.PROJECT_NAME }}
                  cd ~/${{ env.PROJECT_NAME }}
                  tar -xzf ~/${{ env.PROJECT_NAME }}.tar.gz
                  docker compose build
                  docker compose up -d

            # - name: Publish Docker images
            #   run: docker compose push
            # - name: Docker-Compose Remote Deployment
            #   uses: matiasnu/github-action-ssh-docker-compose@master
            #   with:
            #     docker_compose_filename: docker-compose.yml
            #     ssh_host: ${{ secrets.SSH_HOST }}
            #     ssh_port: ${{ secrets.SSH_PORT }}
            #     ssh_user: ${{ secrets.SSH_USER }}
            #     ssh_private_key: ${{ secrets.SSH_CD_KEY }}
