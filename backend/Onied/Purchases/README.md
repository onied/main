# Бекенд покупок

### Зона ответственности

- Подписки, их возможности и автоматическое продление
- Покупки курсов и сертификатов
- Список купленных пользователем товаров и активных подписок

#### Примечание

Подписки - это покупки, имеющие период действия и возможность автопродления.

Для коммуникации используются два интерфейса: HTTP для валидации покупки и AMQP для сообщений о покупках.

Есть что-то типа авторизации, но для сервисов, которые обращаются к этому микросервису. Через event bus он выдает им JWT-токены, которые используются в дальнейшем в запросах к этому микросервису. Фронтенд не имеет доступа к этим токенам. Даже если база данных какого-то микросервиса была изменена вручную, валидность данных все еще можно проверить, отправив этот JWT сюда. Таким образом, до тех пор пока не будет слит JWT ключ, подлинность покупок всегда можно проверить (и нужно проверять). Так как токены передаются по event bus, то злоумышленник может их перехватить (и то, только перехватить, не изменить) только если он имеет доступ к самому event bus или базам данных соответствующих сервисов, но не к самим ASP.NET и Node.JS приложениям.

### Минимальный набор эндпоинтов

- `POST /purchases` - принимает payload (строка JSON с информацией, относящейся к товару), user_id, название покупки, тип покупки, период действия, автопродление (да/нет/не указано), цену покупки, данные карты. Имитирует покупку, возвращает 200 (удачная покупка) или ошибку (403 - не прошла оплата, другие как обычно (400, 401, 404)). Перед возвратом кода ответа отправляет по event bus событие о покупке с токеном покупки.
- `GET /purchases/verify` - принимает токен, проверяет его и возвращает 200 или 404.
- `GET /purchases?userId=...` - должно быть спрятано за API Gateway - возвращает список всех покупок, совершенных пользователем, и отображает их статус (активны / не активны)
- `PUT /purchases/<purchaseID>/auto-renewal` - для изменения автопродления. Принимает токен, проверяет его, и изменяет подписку (если это подписка и токен прошел проверку).

### Сценарии

#### Покупка курса

- Пользователь нажимает на кнопку "купить".
- Попадает на страницу оплаты покупки
- Нажатие на кнопку отправить создает запрос на `/purchases/`, в которую передается course_id, user_id и данные карты. Период действия не указан (единовременная покупка)
- При успешной покупке отправляется событие, содержащее JWT-токен с course_id, user_id и purchase_id. Сам эндпоинт возвращает 200.
- Микросервис курсов принимает это событие, записывает себе что user_id купил курс course_id, и сохраняет токен.
- Фронт пересылает на превью курса, в котором уже вместо кнопки "купить" должна быть кнопка "перейти" (если курс был куплен успешно).
- При обращении от фронта к любой части курса, если он платный, то отправляется HTTP запрос на `/purchases/verify` с токеном. Прошел -> есть доступ, иначе - нет.

#### Покупка сертификата

- См. выше, только вместо микросервиса курсов - микросервис сертификатов.

#### Покупка подписки

- См. выше, только период действия равен периоду подписки, данные передаются на микросервис курсов.
